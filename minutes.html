<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Minutes</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        #app-container {
            max-width: 800px;
            margin: auto;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            text-align: center;
        }

        #minutes-area {
            width: 100%;
            height: 400px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            flex-grow: 1;
        }

        #save-button {
            background-color: #4CAF50;
            color: white;
        }

        #email-button {
            background-color: #2196F3;
            color: white;
        }

        #clear-button {
            background-color: #f44336;
            color: white;
        }

        #shortcuts-toggle {
            background-color: #ff9800;
            color: white;
            flex-grow: 0; /* Keep size small */
            width: auto;
        }

        #shortcuts-editor {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #999;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: none; /* Initially hidden */
        }

        #shortcuts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #shortcuts-table th, #shortcuts-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #shortcuts-table th {
            background-color: #e0e0e0;
        }

        #shortcuts-table input[type="text"] {
            width: 90%;
            padding: 5px;
            border: 1px solid #ccc;
        }

        .add-row-button {
            display: block;
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background-color: #607d8b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <button id="shortcuts-toggle">Show/Hide Shortcuts</button>

        <h1>Meeting Minutes</h1>

        <textarea id="minutes-area" placeholder="Start taking notes here..."></textarea>

        <div class="button-group">
            <button id="save-button">Save to File</button>
            <button id="email-button">Send in Email</button>
            <button id="clear-button">Clear / Discard</button>
        </div>

        <div id="shortcuts-editor">
            <h2>Shortcut Translation Table</h2>
            <table id="shortcuts-table">
                <thead>
                    <tr>
                        <th>Shortcut Key</th>
                        <th>Replacement Text</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button class="add-row-button" onclick="addShortcutRow()">+ Add New Shortcut</button>
            <p style="margin-top: 10px; font-size: 0.9em;">* Shortcuts are applied after you type the trigger key (usually space or Enter).</p>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC ---
        const MINUTES_AREA = document.getElementById('minutes-area');
        const SHORTHAND_KEY = '/'; 
        let shortcuts = [];
        
        // --- Utility to get fresh Date/Time values ---
        function getLiveTimeStr() {
            const now = new Date();
            // Current time: 11:57:53 AM
            return 'Time: ' + now.toLocaleTimeString();
        }

        function getLiveDateStr() {
            const now = new Date();
            // Current date: 12/10/2025
            return 'Date: ' + now.toLocaleDateString();
        }

        function getInitialDateTimeShortcuts(currentShortcuts) {
            // 1. Set Date Shortcut (/dt)
            const dateStr = getLiveDateStr();
            // Use case-insensitive check to find existing entry
            const dtIndex = currentShortcuts.findIndex(s => s.key.toLowerCase() === '/dt');
            if (dtIndex > -1) {
                currentShortcuts[dtIndex].value = dateStr;
            } else {
                currentShortcuts.unshift({ key: '/dt', value: dateStr });
            }

            // 2. Set Time Shortcut (/tm)
            const tmIndex = currentShortcuts.findIndex(s => s.key.toLowerCase() === '/tm');
            // The value is a placeholder/marker; the time will be generated live during keyup.
            if (tmIndex === -1) {
                currentShortcuts.unshift({ key: '/tm', value: 'LIVE_TIME_PLACEHOLDER' });
            }
            
            return currentShortcuts;
        }


        // --- Core Application Functions ---

        function initApp() {
            let persistedShortcuts = JSON.parse(localStorage.getItem('minutesShortcuts')) || [];
            persistedShortcuts = persistedShortcuts.filter(s => s.key.toLowerCase() !== '/dt' && s.key.toLowerCase() !== '/tm');
            
            const defaultShortcuts = [
                { key: '/at', value: '@Action_Item:' },
                { key: '/dec', value: 'Decision: ' }
            ];

            defaultShortcuts.forEach(d => {
                // Case-insensitive check when merging in defaults
                if (!persistedShortcuts.some(p => p.key.toLowerCase() === d.key.toLowerCase())) {
                    persistedShortcuts.push(d);
                }
            });
            
            shortcuts = persistedShortcuts;
            shortcuts = getInitialDateTimeShortcuts(shortcuts);
            
            if (MINUTES_AREA.value.trim() === '') {
                applyShortcut('/dt', true); 
                applyShortcut('/tm', true); 
                MINUTES_AREA.focus();
            }
            renderShortcutsTable();
        }

        function saveShortcuts() {
            const tableBody = document.querySelector('#shortcuts-table tbody');
            const rows = tableBody.querySelectorAll('tr');
            const newShortcuts = [];
            
            rows.forEach(row => {
                const keyInput = row.cells[0].querySelector('input');
                const valueInput = row.cells[1].querySelector('input');
                
                if (keyInput && valueInput && keyInput.value.trim() !== '') {
                    newShortcuts.push({
                        key: keyInput.value.trim(), 
                        value: valueInput.value
                    });
                }
            });

            const savedShortcuts = newShortcuts.filter(s => 
                s.key.toLowerCase() !== '/dt' && s.key.toLowerCase() !== '/tm'
            );

            localStorage.setItem('minutesShortcuts', JSON.stringify(savedShortcuts));
            console.log('Shortcuts saved:', savedShortcuts);

            initApp();
        }

        function renderShortcutsTable() {
            const tableBody = document.querySelector('#shortcuts-table tbody');
            tableBody.innerHTML = ''; 

            shortcuts.forEach(item => {
                const displayValue = item.key.toLowerCase() === '/tm' ? getLiveTimeStr() + ' (Generated live)' : item.value;
                addShortcutRow(item.key, displayValue, false);
            });
        }

        function addShortcutRow(key = '', value = '', focus = true) {
            const tableBody = document.querySelector('#shortcuts-table tbody');
            const newRow = tableBody.insertRow();
            
            // Key Cell
            let cell1 = newRow.insertCell(0);
            cell1.innerHTML = `<input type="text" value="${key}" onchange="saveShortcuts()" placeholder="e.g., /key or ## or 1a">`;

            // Value Cell
            let cell2 = newRow.insertCell(1);
            cell2.innerHTML = `<input type="text" value="${value.replace(/"/g, '&quot;')}" onchange="saveShortcuts()" placeholder="Replacement Phrase">`;
            
            // Action Cell
            let cell3 = newRow.insertCell(2);
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.style.backgroundColor = '#d32f2f';
            removeButton.style.color = 'white';
            removeButton.style.padding = '5px 10px';
            
            // Disable removal/editing for /dt and /tm
            if (key.toLowerCase() === '/dt' || key.toLowerCase() === '/tm') {
                removeButton.disabled = true;
                cell1.querySelector('input').disabled = true;
                cell2.querySelector('input').disabled = true;
                removeButton.style.opacity = 0.5;
            } else {
                removeButton.onclick = () => {
                    tableBody.removeChild(newRow);
                    saveShortcuts(); 
                };
            }

            cell3.appendChild(removeButton);

            if (focus) {
                cell1.querySelector('input').focus();
            }
        }

        function applyShortcut(triggerKey, isInitialization = false) {
            // Find the replacement using a case-insensitive check (used for initialization only, 
            // as triggerKey here is hardcoded as '/dt' or '/tm')
            const match = shortcuts.find(s => s.key.toLowerCase() === triggerKey.toLowerCase());
            
            if (match) {
                const text = MINUTES_AREA.value;
                let replacementValue = match.value;

                // SPECIAL LOGIC: Check if this is the dynamic time shortcut
                if (match.key.toLowerCase() === '/tm') {
                    replacementValue = getLiveTimeStr();
                }

                let lastKeyPos = -1;
                
                if (isInitialization) {
                    // For initialization, we are always appending
                    lastKeyPos = text.length; 
                } else {
                    // For live typing (non-initialization), find where the trigger key was
                    const keyLength = triggerKey.length;
                    const searchStart = text.length - keyLength;
                    
                    if (searchStart >= 0 && text.substring(searchStart, searchStart + keyLength) === triggerKey) {
                        lastKeyPos = searchStart;
                    } else {
                        // Fallback if simple substring comparison fails
                        lastKeyPos = text.lastIndexOf(triggerKey);
                    }
                }


                if (lastKeyPos !== -1) {
                    if (isInitialization) {
                        MINUTES_AREA.value += replacementValue + '\n';
                    } else {
                        // Replace the key with the full phrase
                        MINUTES_AREA.value = text.substring(0, lastKeyPos) + replacementValue + text.substring(lastKeyPos + match.key.length);
                    }
                }
            }
        }

        // --- Event Handlers ---

        document.getElementById('shortcuts-toggle').addEventListener('click', () => {
            const editor = document.getElementById('shortcuts-editor');
            const toggleButton = document.getElementById('shortcuts-toggle');
            
            if (editor.style.display === 'none' || editor.style.display === '') {
                editor.style.display = 'block';
                toggleButton.textContent = 'Hide Shortcuts';
                renderShortcutsTable(); 
            } else {
                editor.style.display = 'none';
                toggleButton.textContent = 'Show/Hide Shortcuts';
            }
        });

        document.getElementById('save-button').addEventListener('click', () => {
            const content = MINUTES_AREA.value;
            const filename = 'meeting_minutes_' + new Date().toISOString().slice(0, 10) + '.txt';
            
            // Create a Blob containing the text
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link element for download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            
            // Programmatically click the link
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('email-button').addEventListener('click', () => {
            const content = MINUTES_AREA.value;
            const subject = encodeURIComponent('Meeting Minutes: ' + new Date().toLocaleDateString());
            const body = encodeURIComponent(content);
            
            // Use the mailto protocol to open the default email client
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });

        document.getElementById('clear-button').addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all the minutes?")) {
                MINUTES_AREA.value = '';
                initApp(); // Re-add default date/time
            }
        });

        MINUTES_AREA.addEventListener('keyup', (e) => {
            const text = MINUTES_AREA.value;
            
            // Check if a trigger key was pressed (Space, Enter, Tab)
            if (e.key === ' ' || e.key === 'Enter' || e.key === 'Tab') {
                
                const tokenSearchArea = text.substring(0, text.length - 1);
                const lastSpace = tokenSearchArea.lastIndexOf(' ');
                const lastEnter = tokenSearchArea.lastIndexOf('\n');
                const lastKey = Math.max(lastSpace, lastEnter);
                
                let potentialShortcut = tokenSearchArea.substring(lastKey + 1).trim();

                if (potentialShortcut.length > 0) {
                
                    // *** MODIFICATION FOR CASE-SENSITIVITY ***
                    // Removed .toLowerCase() to enable /d and /D to be different keys.
                    const match = shortcuts.find(s => s.key === potentialShortcut);

                    if (match) {
                        let replacementValue = match.value;
                        
                        // Handle LIVE TIME requirement:
                        if (match.key.toLowerCase() === '/tm') {
                            replacementValue = getLiveTimeStr();
                        }
                        
                        // Calculate the start position for the replacement
                        const replaceStart = text.length - potentialShortcut.length - 1; 

                        // Rebuild the text area value
                        MINUTES_AREA.value = text.substring(0, replaceStart) + replacementValue;
                        
                        // Only add a new line or space if the replacement value doesn't end with one,
                        // and if the trigger key was Enter (new line) or Space (space)
                        if (e.key === 'Enter') {
                            if (!replacementValue.endsWith('\n')) {
                                MINUTES_AREA.value += '\n';
                            }
                        } else if (e.key === ' ' || e.key === 'Tab') {
                            if (!replacementValue.endsWith(' ')) {
                                MINUTES_AREA.value += ' ';
                            }
                        }

                        // Prevent the default action of the trigger key from being added after substitution
                        e.preventDefault();
                    }
                }
            }
        });

        // Initialize the application on load
        window.onload = initApp;
    </script>

</body>
</html>
